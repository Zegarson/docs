# Flashing Device

## Buildroot

When using Buildroot to build your image, you will find a file named `sdcard.img.gz` in the output directory. This file is automatically generated and contains the correct partition layout for the STM32MP1-based device. To flash this image to an SD card, use the following command:

```sh
gzip -dc sdcard.img.gz | dd of=/dev/sdX bs=1M
```

Replace `/dev/sdX` with the appropriate device identifier for your SD card. Be very careful to select the correct device to avoid overwriting other disks.

### Using Block Map for Faster Flashing

You can speed up the flashing process by using the block map image file, which is available as `output/images/sdcard.img.bmap`. To use this file, both the block map and the SD card image must be in the same directory. Flash the SD card with the following command:

```sh
bmaptool copy sdcard.img.gz /dev/sdX
```

**Note:** `bmaptool` will not erase partitions like the U-Boot environment partition that may be empty. Ensure that your SD card is properly prepared if you encounter issues with partitions.

### Flashing with STM32Cube Programmer

Alternatively, you can flash the device using a `.tsv` file with STM32Cube Programmer. First, generate the `.tsv` file as required. Then use the STM32Cube Programmer CLI to flash the device:

```sh
sudo ~/stm32cube/bin/STM32_Programmer_CLI -c port=usb1 -w flash.tsv
```

Ensure that the STM32Cube Programmer CLI tool is correctly installed and that your device is connected via USB. Replace `port=usb1` with the appropriate port if necessary.

By following these instructions, you can successfully flash your STM32MP1-based device using either the `dd` tool, `bmaptool`, or STM32Cube Programmer.

Hereâ€™s the improved and corrected version of the "Manual" section for flashing the device:

## Manual Flashing

If you have generated all of the images manually without using Buildroot or Yocto build systems, you can manually create and flash partitions on your SD card using the following commands:

### Create a New GPT Partition Table

To create a new GUID Partition Table (GPT) on your SD card, use `sgdisk`:

```sh
sgdisk
sgdisk -o /dev/sdX
```

Replace `/dev/sdX` with the appropriate device identifier for your SD card. Be very careful to select the correct device to avoid overwriting other disks.

### Create Required Partitions

Create and format the necessary partitions on the SD card with the following command:

```sh
sgdisk --resize-table=128 -a 1 \
-n 1:34:545         -c 1:fsbl1 \
-n 2:546:1057               -c 2:fsbl2 \
-n 3:1058:9249              -c 3:fip \
-n 4:9250:                  -c 4:rootfs -A 4:set:2 \
-p /dev/sdX
```

### Copy Binaries onto the Card

Use `dd` to copy the binaries to the appropriate partitions on the SD card:

```sh
dd if=tf-a.stm32 of=/dev/sdX1 bs=1M
dd if=tf-a.stm32 of=/dev/sdX2 bs=1M
dd if=fip.bin of=/dev/sdX3 bs=1M
```

Replace `/dev/sdX` with the appropriate device identifier for your SD card, and ensure that the partition numbers (`1`, `2`, `3`) correspond to the partitions you created earlier.

**Note:** Use the `bs=1M` option to set the block size to 1 MB, which can improve performance when copying large files.

By following these steps, you can manually create and flash partitions on your SD card, allowing you to set up your STM32MP1-based device with custom binaries.
