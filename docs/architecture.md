# OS Architecture

## Boot Chain

The current implementation of the operating system on Zegarson relies on four main components that are executed sequentially during the boot process:

`TF-A -> OP-TEE OS -> U-Boot -> Linux Kernel`

### Arm Trusted Firmware (TF-A)

[Arm Trusted Firmware (TF-A)](https://github.com/STMicroelectronics/arm-trusted-firmware/) is the first stage of the boot process. It acts as the initial bootloader, responsible for essential hardware initialization such as configuring RAM, the Power Management IC (PMIC), and various other subsystems. TF-A also sets up the security architecture by establishing the Chain of Trust if image signing is enforced. This means that all stages of the boot process before U-Boot are treated as trusted components.

### OP-TEE OS

[OP-TEE OS](https://github.com/STMicroelectronics/optee_os/) (Open Portable Trusted Execution Environment) is responsible for maintaining the Chain of Trust established by TF-A. It divides the system into trusted and untrusted zones, allowing sensitive operations to be isolated from the main OS. OP-TEE enforces security policies through mechanisms like Secure Monitor Calls (SMCs), System Control and Management Interface (SCMI), and Trusted Applications (TAs). These policies control access to hardware resources and ensure the integrity of secure operations.

Due to its size, OP-TEE cannot always fit into the internal memory of the STM32MP1 chip. In such cases, there are two solutions:

1. **Untrusted RAM**: Store OP-TEE in RAM and treat it as untrusted. This is the approach used by Zegarson, which sacrifices some security but simplifies the implementation.
2. **Secure Paging**: Store hashes of OP-TEE memory pages in internal memory and validate them when the pager is involved. This approach maintains security without relying on RAM encryption but prevents deeper sleep modes. Zegarson does not use this feature due to the trade-offs it introduces.

### U-Boot

[U-Boot](https://github.com/STMicroelectronics/u-boot/) acts as the third-stage bootloader (BL33 stage). It is a flexible bootloader that can load various operating systems and provides numerous features for developers, such as network boot, device flashing, and debugging tools. U-Boot also integrates with STM32CubeProgrammer, allowing for easy firmware updates via DFU (Device Firmware Update) mode.

### Linux Kernel

Finally, the Linux kernel is loaded by U-Boot as the main operating system for Zegarson. The Linux kernel is an open-source, general-purpose OS kernel. In the Zegarson project, the Linux kernel is used without any significant custom modifications. It serves as the core operating system, managing hardware resources and running user applications.

## DTS

Zegarson uses Device Tree Source files to configure all of the build systems. Theses files are located in the https://github.com/Zegarson/dts repository. This repository contains dts for specific components as well as original unmodified files generated by cubeMX.

### Configured devices

- STM32MP157DAC - SOC
- 04EM04-N3GM627 - eMMC
- STPMIC1B - PMIC
- 04EM04-N3GM627 - LPDDR3
- USB - partial due to lack of tusb320 driver in older builds of uboot which ST provides

### Not configured

- MAX17330 - battery management + charger
- ED178AM368MS - amoled
- microphone - standard PDM
- speaker - D-class amp. I2S

### Problematic driver

- CYW43439 - WIFI/BT:
  - https://community.st.com/t5/stm32-mpus-products/support-for-murata-1yn-cyw43439-chipset/td-p/56761
- ED178AM368MS - amoled:
  - This driver just does not exist and needs to be written from scratch
